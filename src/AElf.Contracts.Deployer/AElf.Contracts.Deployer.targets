<?xml version="1.0"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>
    <PropertyGroup>
        <NoWarn>$(NoWarn);0436</NoWarn>
        <ContractManifestFileName>Contracts.manifest</ContractManifestFileName>
    </PropertyGroup>

    <Target Name="MakeAllContractsReferenceable" BeforeTargets="ResolvePackageDependenciesForBuild">
        <ItemGroup>
            <ProjectReference Condition="'%(ProjectReference.OutputItemType)' == 'Contract'">
                <ReferenceOutputAssembly>true</ReferenceOutputAssembly>
            </ProjectReference>
        </ItemGroup>
    </Target>
    <Target Name="CreateContractsManifest" AfterTargets="ResolveProjectReferences">
        <ItemGroup>
            <Contract Include="@(ProjectReference)" Condition="'%(ProjectReference.OutputItemType)' == 'Contract'"/>
        </ItemGroup>
        <PropertyGroup>
            <AllContracts>@(Contract, ';')</AllContracts>
        </PropertyGroup>
        <ItemGroup>
            <ContractDlls Include="%(_ResolvedProjectReferencePaths.Identity)" Condition="$(AllContracts) != '' And $(AllContracts.Contains(%(_ResolvedProjectReferencePaths.OriginalProjectReferenceItemSpec)))"/>
        </ItemGroup>
        <Delete Files="$(ContractManifestFileName)" ContinueOnError="true"/>
        <GetAssemblyIdentity AssemblyFiles="@(ContractDlls)">
            <Output TaskParameter="Assemblies" ItemName="ContractDllIdentities"/>
        </GetAssemblyIdentity>
        <WriteLinesToFile Condition="@(ContractDllIdentities) != ''" File="$(ContractManifestFileName)" Lines="%(Identity)"/>
        <ItemGroup Condition="Exists($(ContractManifestFileName))">
            <EmbeddedResource Include="$(ContractManifestFileName)"></EmbeddedResource>
        </ItemGroup>
    </Target>
</Project>