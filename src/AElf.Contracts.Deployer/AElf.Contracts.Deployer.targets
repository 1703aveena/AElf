<?xml version="1.0"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>
    <PropertyGroup>
        <NoWarn>$(NoWarn);0436</NoWarn>
        <ContractManifestFileName>Contracts.manifest</ContractManifestFileName>
    </PropertyGroup>

    <Target Name="MakeAllContractsReferenceable" BeforeTargets="ResolvePackageDependenciesForBuild">
        <ItemGroup>
            <NoneReferenceContracts Include="@(ProjectReference)" Condition="'%(ProjectReference.OutputItemType)' == 'Contract' And '%(ProjectReference.ReferenceOutputAssembly)' != 'true'"/>
            <ProjectReference Condition="'%(ProjectReference.OutputItemType)' == 'Contract'">
                <ReferenceOutputAssembly>true</ReferenceOutputAssembly>
            </ProjectReference>
        </ItemGroup>
    </Target>
    <Target Name="RevertBackContracts" BeforeTargets="ResolveAssemblyReferences" AfterTargets="CreateContractsManifest">
        <PropertyGroup>
            <AllNonReferenceContracts>@(NoneReferenceContracts, ';')</AllNonReferenceContracts>
        </PropertyGroup>
        <ItemGroup>
            <!-- Remove AllNonReferenceContracts -->
            <Removed_ResolvedProjectReferencePaths Include="@(_ResolvedProjectReferencePaths)" Condition="'$(AllNonReferenceContracts)' != '' And $(AllNonReferenceContracts.Contains(%(_ResolvedProjectReferencePaths.OriginalProjectReferenceItemSpec)))"/>
            <_ResolvedProjectReferencePaths Remove="@(_ResolvedProjectReferencePaths)" Condition="'$(AllNonReferenceContracts)' != '' And $(AllNonReferenceContracts.Contains(%(_ResolvedProjectReferencePaths.OriginalProjectReferenceItemSpec)))"/>    
        </ItemGroup>
    </Target>
    <Target Name="AddContractsReferenceBack" AfterTargets="ResolveAssemblyReferences" BeforeTargets="ResolvePackageDependenciesForBuildDependsOn">
        <ItemGroup>
            <_ResolvedProjectReferencePaths Include="@(Removed_ResolvedProjectReferencePaths)"/>
        </ItemGroup>
    </Target>
    <Target Name="CreateContractsManifest" BeforeTargets="ResolveReferences" AfterTargets="ResolveProjectReferences">
        <ItemGroup>
            <Contract Include="@(ProjectReference)" Condition="'%(ProjectReference.OutputItemType)' == 'Contract'"/>
        </ItemGroup>
        <PropertyGroup>
            <AllContracts>@(Contract, ';')</AllContracts>
        </PropertyGroup>
        <ItemGroup>
            <ContractDlls Include="%(_ResolvedProjectReferencePaths.Identity)" Condition="$(AllContracts) != '' And $(AllContracts.Contains(%(_ResolvedProjectReferencePaths.OriginalProjectReferenceItemSpec)))"/>
        </ItemGroup>
        <Delete Files="$(ContractManifestFileName)" ContinueOnError="true"/>
        <GetAssemblyIdentity AssemblyFiles="@(ContractDlls)">
            <Output TaskParameter="Assemblies" ItemName="ContractDllIdentities"/>
        </GetAssemblyIdentity>
        <WriteLinesToFile Condition="@(ContractDllIdentities) != ''" File="$(ContractManifestFileName)" Lines="%(Identity)"/>
        <ItemGroup Condition="Exists($(ContractManifestFileName))">
            <EmbeddedResource Include="$(ContractManifestFileName)"/>
        </ItemGroup>
    </Target>
</Project>